<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tag: http | sTa4ever 博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="sTa4ever 博客">
<meta property="og:url" content="http://sta4ever.github.io/tags/http/">
<meta property="og:site_name" content="sTa4ever 博客">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="sTa4ever 博客">
<meta name="twitter:description">

  
    <link rel="alternative" href="/atom.xml" title="sTa4ever 博客" type="application/atom+xml">
  
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="overlay"></div>
  <div id="header-outer" class="outer">
    <div id="profile_img">
      <img id="circle_img" src="holder.js/150x150" />
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">sTa4ever 博客</a>
      </h1>
      
    </div>
    <div id="header-menu">
      <nav id="main-nav">
        <ul>
        
          <li><a href="/"><i class="fa fa-home icon-setting"></i></a></li>
        
          <li><a href="/archives"><i class="fa fa-archive icon-setting"></i></a></li>
        
          <li><a href="/about"><i class="fa fa-user icon-setting"></i></a></li>
        
        
          <li><a href="/atom.xml"><i class="fa fa-rss %> icon-setting"></i></a></li>
        
        </ul>
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-token设计" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/12/16/token设计/" class="article-date">
  <time datetime="2014-12-16T08:48:08.000Z" itemprop="datePublished">Dec 16 2014</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/16/token设计/">token设计</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>token作为http通信安全性方面的一个验证被广泛使用。不同的业务场景，token的设计也不同。<br>不过通常来说，token包含下面特性：1）必要的业务数据；2）签名串；3）自验证；4）可解析。</p>
<h3 id="游戏通信的一种token设计">游戏通信的一种token设计</h3>
<p>下面就游戏通信方面给出一个设计，直接给出php代码</p>
<pre><code><span class="comment">/**
 * 获取通信access token
 *
 *<span class="phpdoc"> @param</span> string $platform 游戏平台
 *<span class="phpdoc"> @param</span> string $section  游戏分区
 *<span class="phpdoc"> @param</span> string $uid      玩家uid
 *<span class="phpdoc"> @param</span> int    $t        时间戳
 *<span class="phpdoc"> @param</span> int    $life     生命周期
 *<span class="phpdoc"> @param</span> string $secret   签名串需要的密钥
 *<span class="phpdoc"> @return</span> string
 */</span>
<span class="function"><span class="keyword">function</span> <span class="title">getAccessToken</span><span class="params">(<span class="variable">$platform</span>, <span class="variable">$section</span>, <span class="variable">$uid</span>, <span class="variable">$t</span>, <span class="variable">$life</span>, <span class="variable">$secret</span>)</span>
</span>{
    <span class="variable">$params</span> = <span class="keyword">array</span>(
        <span class="string">'platfrom'</span> =&gt; <span class="variable">$platform</span>,
        <span class="string">'section'</span>  =&gt; <span class="variable">$section</span>,
        <span class="string">'uid'</span>      =&gt; <span class="variable">$uid</span>,
        <span class="string">'t'</span>        =&gt; <span class="variable">$t</span>,
        <span class="string">'life'</span>     =&gt; <span class="variable">$life</span>,
    );
    <span class="variable">$sign</span> = getSign(<span class="variable">$params</span>, <span class="variable">$secret</span>); <span class="comment">// 该接口参照以前写的签名设计</span>
    <span class="keyword">return</span> sprintf(<span class="string">"1.%s.%s.%d.%d.$d.$s"</span>, <span class="variable">$platform</span>, <span class="variable">$section</span>, <span class="variable">$uid</span>, <span class="variable">$t</span>, <span class="variable">$life</span>, <span class="variable">$sign</span>);
}

<span class="comment">/**
 * 检测access token有效性
 * 
 *<span class="phpdoc"> @param</span> string $token
 *<span class="phpdoc"> @return</span> bool
 */</span>
<span class="function"><span class="keyword">function</span> <span class="title">checkAccessToken</span><span class="params">()</span>
</span>{
    <span class="keyword">list</span>(<span class="variable">$type</span>, platform, <span class="variable">$section</span>, <span class="variable">$uid</span>, <span class="variable">$t</span>, <span class="variable">$life</span>, <span class="variable">$sign</span>) = explode(<span class="string">'.'</span>, <span class="variable">$token</span>);
    <span class="variable">$params</span> = <span class="keyword">array</span>(
        <span class="string">'platfrom'</span> =&gt; <span class="variable">$platform</span>,
        <span class="string">'section'</span>  =&gt; <span class="variable">$section</span>,
        <span class="string">'uid'</span>      =&gt; <span class="variable">$uid</span>,
        <span class="string">'t'</span>        =&gt; <span class="variable">$t</span>,
        <span class="string">'life'</span>     =&gt; <span class="variable">$life</span>,
    );
    <span class="keyword">return</span> <span class="variable">$sign</span> == getSign(<span class="variable">$params</span>, <span class="variable">$secret</span>)
}
</code></pre><h3 id="时效性解决">时效性解决</h3>
<p>上面给出的算法，能验证token的正确性，也可以通过（$t + $life）小于当前时间戳来简单处理时效问题。但是在生命周期中，如果多点登录，任一登陆点的token都有效。<br>为解决这一问题，一般会采用redis或者memcache，存储每次登录的时间，验证token时，可通过$t与登录时间的比对，验证token生命周期。<br>上面的解决方法仍由一个缺陷，玩家单点登录，如果申请多个token，那么也会有多个有效token。我们可以在省城token时，更新缓存时间来解决问题。有人说，可以通过存储token，当重新申请token时，如果原有token有效，直接返回原token。token的自验证就是为了不存储的，所以不建议存储token。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sta4ever.github.io/2014/12/16/token设计/" data-id="tfu44coo65aozw43" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/http/">http</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/token/">token</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2014 sTa4ever<br>
      <a href="https://github.com/ken8203/hexo-theme-alberta" target="_blank">Alberta</a> by <a href="http://jaychung.tw" target="_blank">jaychung</a>. Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Thank <a href="http://subtlepatterns.com/" target="_blank">Subtlepatterns</a>
    </div>
  </div>
</footer>
    </div>
    
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="//imsky.github.io/holder/holder.js"></script>

  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/js/script.js" type="text/javascript"></script>


  </div>
</body>
</html>